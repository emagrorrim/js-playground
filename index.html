<!DOCTYPE HTML>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./index.css">
    <script src="./utls/logger.js"></script>
  </head>
  <body>
    <div id="videoContainer"></div>
    <select name="devices" id="devices" onchange = "cameraswitch(this.value);return false;"></select>
    <script src="https://rtcmulticonnection.herokuapp.com/dist/RTCMultiConnection.js"></script>
    <script src="https://rtcmulticonnection.herokuapp.com/node_modules/webrtc-adapter/out/adapter.js"></script>
    <script src="https://rtcmulticonnection.herokuapp.com/socket.io/socket.io.js"></script>
    <script>
      const setupCameraSelector = async () => {
        const devices = (await navigator.mediaDevices.enumerateDevices()).filter(device => device.kind === 'videoinput');
        console.log(devices);
        const selector = document.getElementById("devices");
        selector.innerText = "";
        devices.forEach(device => {
          const option = document.createElement('option');
          option.value = device.deviceId;
          option.innerText = device.label;
          selector.appendChild(option);
        });

      };
      window.onload = function () {
        var b = 'test12345';
        connection.openOrJoin(b, function (isJoined, roomid, error) { 
          setupCameraSelector();
        });
      }
      var connection = new RTCMultiConnection();
      connection.socketURL = 'https://rtcmulticonnection.herokuapp.com:443/';
      connection.session = {
        audio: true,
        video: true
      };

      connection.onstreamended = function (event) {
        console.log('onstreamended');
        // var mediaElement = document.getElementById(event.streamid);
        // if (mediaElement) {
        //   mediaElement.parentNode.removeChild(mediaElement);
        // }
      };

      // if ({!!showVideo}) {
      //   connection.mediaConstraints.video = false;
      // }

      async function cameraswitch(deviceId) {
        console.log(deviceId);
        var video = document.querySelector('video');
        var stream = video.srcObject;
        stream.getTracks().forEach(track => {
          track.stop();
        });
        connection.removeStream(stream.streamid, connection.userid);
        connection.codecs.video = 'VP8';
        connection.bandwidth = { // all values in kbits/per/seconds
          audio: 192,
          video: 512,
          screen: 512
        };
        connection.videosContainer = document.getElementById('videoContainer')
        connection.mediaConstraints.video = { deviceId: { exact: deviceId } };
        // connection.mediaConstraints.video.optional.push({
        //   bandwidth: connection.bandwidth.video * 8 * 1024 || 128 * 8 * 1024
        // });
        // console.log(connection.mediaConstraints.video);
        const newStream = await navigator.mediaDevices.getUserMedia(connection.mediaConstraints);
        video.srcObject = newStream;
        console.log(newStream);
        connection.addStream(newStream);
      }
    </script>
  </body>
</html>
